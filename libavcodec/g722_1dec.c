/*
 * This file is part of FFmpeg.
 *
 * FFmpeg is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * FFmpeg is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with FFmpeg; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
 */

#include "libavutil/channel_layout.h"
#include "libavutil/mem.h"
#include "libavutil/thread.h"
#include "libavutil/tx.h"
#include "libavutil/float_dsp.h"
#include "libavutil/mem_internal.h"

#include "avcodec.h"
#include "bswapdsp.h"
#include "codec_internal.h"
#include "decode.h"
#include "get_bits.h"
#include "vlc.h"

static const uint8_t vector_dimension[8] = { 2, 2, 2, 4, 4, 5, 5, 0 };
static const uint8_t number_of_vectors[8] = { 10, 10, 10, 5, 5, 4, 4, 0 };
static const uint8_t expected_bits_table[8] = { 52, 47, 43, 37, 29, 22, 16, 0 };

static const uint8_t diff_len[][24] = {
    { 4, 6, 5, 5, 4, 4, 4, 4, 4, 4, 3, 3, 3, 4, 5, 7, 8, 9, 11, 11, 12, 12, 12, 12, },
    { 10, 8, 6, 5, 5, 4, 3, 3, 3, 3, 3, 3, 4, 5, 7, 9, 11, 12, 13, 15, 15, 15, 16, 16, },
    { 12, 10, 8, 6, 5, 4, 4, 4, 4, 4, 4, 3, 3, 3, 4, 4, 5, 5, 7, 9, 11, 13, 14, 14, },
    { 13, 10, 9, 9, 7, 7, 5, 5, 4, 3, 3, 3, 3, 3, 4, 4, 4, 5, 7, 9, 11, 13, 13, 13, },
    { 12, 13, 10, 8, 6, 6, 5, 5, 4, 4, 3, 3, 3, 3, 3, 4, 5, 5, 6, 7, 9, 11, 14, 14, },
    { 12, 11, 9, 8, 8, 7, 5, 4, 4, 3, 3, 3, 3, 3, 4, 4, 5, 5, 7, 8, 10, 13, 14, 14, },
    { 15, 16, 15, 12, 10, 8, 6, 5, 4, 3, 3, 3, 2, 3, 4, 5, 5, 7, 9, 11, 13, 16, 16, 16 },
    { 14, 14, 11, 10, 9, 7, 7, 5, 5, 4, 3, 3, 2, 3, 3, 4, 5, 7, 9, 9, 12, 14, 15, 15, },
    { 9, 9, 9, 8, 7, 6, 5, 4, 3, 3, 3, 3, 3, 3, 4, 5, 6, 7, 8, 10, 11, 12, 13, 13, },
    { 14, 12, 10, 8, 6, 6, 5, 4, 3, 3, 3, 3, 3, 3, 4, 5, 6, 8, 8, 9, 11, 14, 14, 14, },
    { 13, 10, 9, 8, 6, 6, 5, 4, 4, 4, 3, 3, 2, 3, 4, 5, 6, 8, 9, 9, 11, 12, 14, 14, },
    { 16, 13, 12, 11, 9, 6, 5, 5, 4, 4, 4, 3, 2, 3, 3, 4, 5, 7, 8, 10, 14, 16, 16, 16, },
    { 13, 14, 14, 14, 10, 8, 7, 7, 5, 4, 3, 3, 2, 3, 3, 4, 5, 5, 7, 9, 11, 14, 14, 14, },
};

static const uint16_t diff_code[][24] = {
    { 0x000008, 0x000026, 0x000012, 0x00000A, 0x000007, 0x000006, 0x000003, 0x000002, 0x000000, 0x000001, 0x000007, 0x000006, 0x000005, 0x000004, 0x00000B, 0x00004E, 0x00009E, 0x00013E, 0x0004FE, 0x0004FF, 0x0009F8, 0x0009F9, 0x0009FA, 0x0009FB, },
    { 0x000024, 0x000008, 0x000003, 0x000005, 0x000000, 0x000001, 0x000007, 0x000006, 0x000004, 0x000003, 0x000002, 0x000005, 0x000003, 0x000004, 0x000005, 0x000013, 0x00004A, 0x000096, 0x00012E, 0x0004BD, 0x0004BE, 0x0004BF, 0x000978, 0x000979, },
    { 0x000A16, 0x000284, 0x0000A0, 0x000029, 0x000005, 0x00000B, 0x000007, 0x000005, 0x000004, 0x000001, 0x000000, 0x000006, 0x000004, 0x000007, 0x000003, 0x000006, 0x000004, 0x000015, 0x000051, 0x000143, 0x00050A, 0x00142F, 0x00285C, 0x00285D, },
    { 0x000B7C, 0x00016E, 0x0000B5, 0x0000B4, 0x00002F, 0x00002E, 0x00001B, 0x00000A, 0x000008, 0x000005, 0x000001, 0x000000, 0x000003, 0x000007, 0x000004, 0x000009, 0x00000C, 0x00001A, 0x00002C, 0x0000B6, 0x0002DE, 0x000B7D, 0x000B7E, 0x000B7F, },
    { 0x000F8E, 0x001F1F, 0x0003E2, 0x0000F9, 0x00003F, 0x00001A, 0x000013, 0x000012, 0x00000E, 0x000008, 0x000006, 0x000001, 0x000000, 0x000002, 0x000005, 0x000007, 0x00000C, 0x00001E, 0x00001B, 0x00007D, 0x0001F0, 0x0007C6, 0x003E3C, 0x003E3D, },
    { 0x000CB6, 0x00065A, 0x000197, 0x0000CE, 0x0000CA, 0x000064, 0x00001E, 0x00000E, 0x000003, 0x000005, 0x000003, 0x000000, 0x000002, 0x000004, 0x000002, 0x00000D, 0x000018, 0x00001F, 0x000066, 0x0000CF, 0x00032C, 0x00196F, 0x0032DC, 0x0032DD, },
    { 0x000456, 0x0008A8, 0x000457, 0x00008B, 0x000023, 0x000009, 0x000003, 0x000014, 0x00000B, 0x000004, 0x000002, 0x000001, 0x000003, 0x000003, 0x000001, 0x000000, 0x000015, 0x000005, 0x000010, 0x000044, 0x000114, 0x0008A9, 0x0008AA, 0x0008AB, },
    { 0x0003F5, 0x0003F6, 0x00007F, 0x00003E, 0x00001D, 0x000006, 0x000004, 0x000010, 0x000000, 0x000001, 0x000003, 0x000002, 0x000003, 0x000001, 0x000005, 0x000009, 0x000011, 0x000005, 0x00001C, 0x00001E, 0x0000FC, 0x0003F7, 0x0007E8, 0x0007E9, },
    { 0x00017D, 0x00017C, 0x000174, 0x0000BF, 0x00005E, 0x00002C, 0x000010, 0x00000A, 0x000007, 0x000003, 0x000001, 0x000000, 0x000002, 0x000006, 0x000009, 0x000011, 0x00002D, 0x00005C, 0x0000BB, 0x0002EA, 0x0005D6, 0x000BAF, 0x00175C, 0x00175D, },
    { 0x000BDC, 0x0002F6, 0x0000BC, 0x00002D, 0x00002B, 0x00000A, 0x000004, 0x000003, 0x000006, 0x000004, 0x000002, 0x000000, 0x000003, 0x000007, 0x00000B, 0x000014, 0x00002A, 0x00002C, 0x00002E, 0x00005F, 0x00017A, 0x000BDD, 0x000BDE, 0x000BDF, },
    { 0x0002EF, 0x00005C, 0x00002D, 0x000014, 0x00001A, 0x000004, 0x00000C, 0x000007, 0x000004, 0x000000, 0x000004, 0x000001, 0x000003, 0x000005, 0x000005, 0x000003, 0x00001B, 0x000015, 0x00002C, 0x00002F, 0x0000BA, 0x000176, 0x0005DC, 0x0005DD, },
    { 0x00B204, 0x001641, 0x000B21, 0x000591, 0x000165, 0x00002D, 0x000017, 0x000006, 0x00000A, 0x000007, 0x000002, 0x000002, 0x000003, 0x000000, 0x000004, 0x000006, 0x000007, 0x000058, 0x0000B3, 0x0002C9, 0x002C80, 0x00B205, 0x00B206, 0x00B207, },
    { 0x0009CF, 0x001398, 0x00139A, 0x001399, 0x000138, 0x00004F, 0x000026, 0x000024, 0x00001E, 0x00000E, 0x000006, 0x000000, 0x000002, 0x000001, 0x000003, 0x000005, 0x000008, 0x00001F, 0x000025, 0x00009D, 0x000272, 0x00139B, 0x00139C, 0x00139D, },
};

static const uint16_t category0_code[] = {
    0x000001, 0x000002, 0x000001, 0x000018, 0x00000E, 0x000033, 0x000009,
    0x000044, 0x00006E, 0x00001A, 0x0000DA, 0x000036, 0x00009A, 0x0002F9,
    0x000003, 0x00000A, 0x000016, 0x000008, 0x00003A, 0x000016, 0x000047,
    0x000010, 0x00001E, 0x000032, 0x0000D5, 0x00004B, 0x00005E, 0x000278,
    0x00000F, 0x000012, 0x000034, 0x000017, 0x00006B, 0x000005, 0x000036,
    0x00003F, 0x0000EF, 0x00002E, 0x000114, 0x00010F, 0x000353, 0x0000FC,
    0x00001C, 0x00000A, 0x00000C, 0x000001, 0x000016, 0x000085, 0x0000BF,
    0x000037, 0x000069, 0x000116, 0x00013D, 0x00022A, 0x000136, 0x000114,
    0x000020, 0x000032, 0x00005E, 0x000014, 0x0000BB, 0x0000DB, 0x00000D,
    0x00010C, 0x0001D9, 0x0001BD, 0x000091, 0x000351, 0x0004FD, 0x00026F,
    0x000001, 0x00000E, 0x000000, 0x000037, 0x0000EE, 0x000079, 0x000078,
    0x00010D, 0x00013E, 0x000212, 0x00027F, 0x00045D, 0x0001FD, 0x00022C,
    0x000018, 0x00004E, 0x000033, 0x000099, 0x00003E, 0x000134, 0x000010,
    0x000019, 0x000044, 0x000422, 0x0001AC, 0x000115, 0x0008B9, 0x00045A,
    0x00005C, 0x00006C, 0x00008D, 0x0000DF, 0x00010E, 0x00017D, 0x000018,
    0x0000D4, 0x0002F8, 0x000023, 0x000427, 0x000117, 0x0006B5, 0x000D6F,
    0x000007, 0x000015, 0x000098, 0x000049, 0x000135, 0x000136, 0x00005F,
    0x0003B0, 0x000762, 0x0008B8, 0x000763, 0x0013F3, 0x0027E5, 0x001375,
    0x00003D, 0x00003E, 0x000009, 0x00004F, 0x0001DA, 0x0001DB, 0x000350,
    0x000423, 0x000420, 0x0006B4, 0x00008B, 0x001372, 0x001377, 0x00008C,
    0x0000BA, 0x00004C, 0x0001BC, 0x000090, 0x000279, 0x000421, 0x000346,
    0x0008BD, 0x001178, 0x001179, 0x0027E4, 0x00004A, 0x00004E, 0x000137,
    0x0000D5, 0x000352, 0x000426, 0x00045F, 0x0001FC, 0x000114, 0x000115,
    0x001376, 0x0000D0, 0x000046, 0x00022B, 0x0001A2, 0x000044, 0x0001FE,
    0x0009F8, 0x00045B, 0x001374, 0x001373, 0x0000D7, 0x000047, 0x0000FD,
    0x0001FF, 0x000347, 0x0006B6, 0x0009B8, 0x001ADC, 0x001ADD,
};

static const uint16_t category0_symbol[] = {
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18,
    19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34,
    35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51,
    52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68,
    69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85,
    86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101,
    102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114,
    115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127,
    128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 140, 141,
    142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 154, 155, 156,
    157, 158, 159, 160, 161, 162, 163, 164, 168, 169, 170, 171, 172,
    173, 174, 175, 176, 177, 182, 183, 184, 185, 186, 187, 188, 189, 190,
};

static const uint8_t category0_len[] = {
    1, 4, 6, 6, 7, 7, 8, 8, 8, 9, 9, 10, 11, 11, 4, 5, 6, 7, 7, 8, 8,
    9, 9, 9, 9, 10, 11, 11, 5, 6, 7, 8, 8, 9, 9, 9, 9, 10, 10, 10, 11,
    12, 6, 7, 8, 9, 9, 9, 9, 10, 10, 10, 10, 11, 12, 13, 7, 7, 8, 9,
    9, 9, 10, 10, 10, 10, 11, 11, 12, 13, 8, 8, 9, 9, 9, 10, 10, 10,
    10, 11, 11, 12, 13, 14, 8, 8, 9, 9, 10, 10, 11, 11, 11, 12, 12, 13,
    13, 15, 8, 8, 9, 9, 10, 10, 11, 11, 11, 12, 12, 13, 14, 15, 9, 9,
    9, 10, 10, 10, 11, 11, 12, 13, 12, 14, 15, 16, 9, 9, 10, 10, 10,
    10, 11, 12, 12, 14, 14, 16, 16, 9, 9, 10, 10, 11, 11, 12, 13, 13,
    14, 14, 15, 10, 10, 10, 11, 11, 12, 12, 13, 15, 15, 16, 11, 11,
    11, 12, 13, 13, 13, 15, 16, 16, 11, 11, 12, 13, 13, 14, 15, 16, 16,
};

static const uint16_t category1_code[] = {
    0x000001, 0x000002, 0x00000B, 0x00001B, 0x00001F, 0x000009, 0x000078,
    0x00001F, 0x000113, 0x000136, 0x000001, 0x000000, 0x00000C, 0x000005,
    0x000021, 0x000036, 0x000066, 0x00006F, 0x0000F6, 0x0001C0, 0x00000A,
    0x00000E, 0x00001F, 0x000027, 0x00003B, 0x000064, 0x000072, 0x0000CA,
    0x0001E5, 0x0003C9, 0x000018, 0x00001A, 0x000024, 0x000034, 0x000067,
    0x00001E, 0x000078, 0x0000F2, 0x000045, 0x0004DC, 0x000023, 0x000020,
    0x00000E, 0x00003D, 0x000071, 0x000075, 0x0000E9, 0x0001E6, 0x0001E7,
    0x0009BB, 0x00000D, 0x00000C, 0x000045, 0x00006E, 0x000095, 0x000023,
    0x0001EF, 0x0001C1, 0x0007BA, 0x001E47, 0x00004C, 0x00004B, 0x00007A,
    0x000088, 0x0000D5, 0x000044, 0x00026F, 0x0003A2, 0x000F77, 0x0026E9,
    0x000073, 0x000010, 0x00006B, 0x0000E1, 0x0001A8, 0x000352, 0x000790,
    0x001EEC, 0x001375, 0x000094, 0x00009A, 0x0000F3, 0x000197, 0x0003DC,
    0x000353, 0x001E46, 0x004DD0, 0x000196, 0x000112, 0x0001D0, 0x0003A3,
    0x000F22, 0x001EED, 0x004DD1,
};

static const uint16_t category1_symbol[] = {
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18,
    19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34,
    35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
    51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66,
    67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 80, 81, 82, 83,
    84, 85, 86, 87, 90, 91, 92, 93, 94, 95, 96,
};

static const uint8_t category1_len[] = {
    1, 4, 5, 6, 7, 8, 8, 9, 10, 10, 4, 5, 6, 7, 7, 8, 8, 9, 9, 11, 5,
    5, 6, 7, 8, 8, 9, 9, 10, 11, 6, 6, 7, 8, 8, 9, 9, 10, 11, 12, 7,
    7, 8, 8, 9, 9, 10, 11, 11, 13, 8, 8, 8, 9, 9, 10, 10, 11, 12, 14,
    8, 8, 8, 9, 10, 11, 11, 12, 13, 15, 9, 9, 9, 10, 11, 12, 12, 14,
    14, 9, 9, 9, 10, 11, 12, 14, 16, 10, 10, 11, 12, 13, 14, 16,
};

static const uint16_t category2_code[] = {
    0x000001, 0x000000, 0x00000A, 0x00000B, 0x00001C, 0x00003E, 0x00016B,
    0x000003, 0x000002, 0x000009, 0x000008, 0x000018, 0x000035, 0x000160,
    0x000007, 0x000008, 0x00000D, 0x000019, 0x000059, 0x00004A, 0x000163,
    0x00000A, 0x000017, 0x000018, 0x00001D, 0x000037, 0x000162, 0x0005A9,
    0x000019, 0x000013, 0x00001E, 0x000034, 0x00006C, 0x0001B6, 0x0016A1,
    0x00005B, 0x000024, 0x00003F, 0x000161, 0x0002D5, 0x002D40, 0x005A82,
    0x0000B4, 0x00004B, 0x0000DA, 0x0001B7, 0x000B51, 0x005A83,
};

static const uint16_t category2_symbol[] = {
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18,
    19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34,
    35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47,
};

static const uint8_t category2_len[] = {
    1, 4, 5, 7, 8, 9, 10, 3, 4, 5, 7, 8, 9, 10, 5, 5, 6, 7, 8, 10, 10,
    7, 6, 7, 8, 9, 10, 12, 8, 8, 8, 9, 10, 12, 14, 8, 9, 9, 10, 11,
    15, 16, 9, 10, 11, 12, 13, 16,
};

static const uint16_t category3_code[] = {
    0x000003, 0x000008, 0x00002E, 0x000091, 0x0000E4, 0x000004, 0x000008,
    0x00002F, 0x00001C, 0x0001C7, 0x000059, 0x000002, 0x0000B4, 0x000005,
    0x000537, 0x0000FA, 0x00000C, 0x000284, 0x00051F, 0x00008B, 0x0002D9,
    0x0000FB, 0x000366, 0x00087C, 0x0008A3, 0x000005, 0x000017, 0x000070,
    0x00014E, 0x0005BD, 0x000015, 0x000003, 0x000005, 0x00006F, 0x0007DE,
    0x000058, 0x00004F, 0x000098, 0x00007C, 0x000A7D, 0x000129, 0x000030,
    0x00006E, 0x00051E, 0x000095, 0x0001F5, 0x0004CF, 0x000099, 0x0008DB,
    0x000A09, 0x000039, 0x00000D, 0x00028D, 0x000A1B, 0x00008F, 0x00004B,
    0x00007C, 0x000076, 0x000A33, 0x00147A, 0x00003D, 0x000032, 0x0000FD,
    0x000E31, 0x0008A8, 0x0001DC, 0x000027, 0x000039, 0x000786, 0x0008BC,
    0x000A1A, 0x000531, 0x000780, 0x000A06, 0x000128, 0x0000E9, 0x000A1E,
    0x0008C0, 0x0008A9, 0x0000FD, 0x000265, 0x000363, 0x000090, 0x00013E,
    0x000266, 0x0000FC, 0x000A1D, 0x0008C2, 0x0008AA, 0x000368, 0x000362,
    0x00088B, 0x0008F8, 0x00086B, 0x000A08, 0x0008B3, 0x000096, 0x000A07,
    0x0000C7, 0x000A7E, 0x000870, 0x0008F2, 0x004AC9, 0x0000E8, 0x000A78,
    0x000080, 0x000890, 0x0008A4, 0x000A7C, 0x000319, 0x0008E9, 0x0008AF,
    0x00078E, 0x000875, 0x000862, 0x0008F3, 0x0008AE, 0x00088D, 0x000006,
    0x000004, 0x000052, 0x0002D5, 0x000E30, 0x00000F, 0x000015, 0x000038,
    0x000257, 0x000094, 0x000003, 0x0000A2, 0x00002A, 0x00019B, 0x0008FD,
    0x0002DF, 0x00028E, 0x0003A2, 0x000089, 0x000A1A, 0x000365, 0x000536,
    0x00078B, 0x0008FC, 0x0008A5, 0x000009, 0x000016, 0x000092, 0x00050A,
    0x001478, 0x000005, 0x00000C, 0x000035, 0x000276, 0x00036B, 0x000050,
    0x000009, 0x000008, 0x000056, 0x0007D2, 0x0000D2, 0x000075, 0x000038,
    0x0007E3, 0x000872, 0x000092, 0x00018D, 0x000364, 0x000083, 0x000867,
    0x00004D, 0x0000A0, 0x00016D, 0x000A32, 0x0008CC, 0x00003B, 0x000036,
    0x000029, 0x000A1F, 0x000788, 0x0000E2, 0x00000E, 0x000079, 0x0016A0,
    0x0008F7, 0x0004AD, 0x0002D8, 0x000198, 0x000082, 0x00086D, 0x000E33,
    0x00009B, 0x000A0D, 0x000A1B, 0x00013A, 0x000040, 0x000090, 0x00087D,
    0x000880, 0x000073, 0x00001E, 0x000199, 0x000099, 0x000A1E, 0x000277,
    0x00001A, 0x0012B3, 0x0008AD, 0x00087E, 0x000A7B, 0x000747, 0x000A0C,
    0x00013F, 0x000866, 0x000881, 0x000892, 0x000A0B, 0x0008D1, 0x000041,
    0x000091, 0x0008CB, 0x00086C, 0x000871, 0x00038D, 0x000360, 0x000891,
    0x000895, 0x0008C6, 0x000A1C, 0x0016A5, 0x00009C, 0x0008D2, 0x00086E,
    0x000897, 0x0008A6, 0x000868, 0x00088C, 0x0008D8, 0x00001E, 0x000075,
    0x0000DB, 0x000361, 0x0008D7, 0x000093, 0x00007F, 0x0000EF, 0x00019A,
    0x0008C7, 0x00001B, 0x000144, 0x0005BC, 0x000A79, 0x000884, 0x000530,
    0x001479, 0x000093, 0x00008E, 0x0008BD, 0x0008C1, 0x0008C5, 0x000781,
    0x0008D6, 0x000029, 0x00000B, 0x0001F9, 0x000A7A, 0x000A1F, 0x000000,
    0x00001A, 0x0000E5, 0x0007DF, 0x000A11, 0x0001D0, 0x000062, 0x000057,
    0x00147B, 0x000876, 0x000095, 0x0007E0, 0x00147C, 0x00088E, 0x000896,
    0x002565, 0x002D4E, 0x002D4F, 0x0008BB, 0x000090, 0x00012A, 0x0003EC,
    0x00147D, 0x0008E5, 0x00009C, 0x000068, 0x0000FE, 0x000A00, 0x000782,
    0x000264, 0x000145, 0x0007E1, 0x000081, 0x000A1C, 0x000A30, 0x000532,
    0x000367, 0x000860, 0x000861, 0x000084, 0x000863, 0x000864, 0x000865,
    0x000077, 0x000533, 0x000085, 0x000869, 0x00086A, 0x0000D3, 0x00003A,
    0x000A31, 0x000783, 0x00086F, 0x0001FE, 0x0000A3, 0x00147E, 0x000873,
    0x000874, 0x000784, 0x000086, 0x000877, 0x000878, 0x000879, 0x00087A,
    0x00087B, 0x000534, 0x000087, 0x000088, 0x00087F, 0x000096, 0x000369,
    0x000882, 0x000883, 0x000785, 0x000885, 0x000886, 0x000887, 0x000888,
    0x000889, 0x00088A, 0x00003A, 0x000146, 0x000A7F, 0x00008A, 0x00088F,
    0x00001F, 0x000042, 0x00036A, 0x000893, 0x000894, 0x000097, 0x000098,
    0x000787, 0x000898, 0x000899, 0x00089A, 0x00089B, 0x00089C, 0x00089D,
    0x00089E, 0x00089F, 0x0008A0, 0x0008A1, 0x0008A2, 0x000037, 0x000067,
    0x0004CE, 0x00008C, 0x0008A7, 0x000076, 0x00000F, 0x000535, 0x0008AB,
    0x0008AC, 0x0007E2, 0x0001FF, 0x00008D, 0x0008B0, 0x0008B1, 0x0008B2,
    0x000789, 0x0008B4, 0x0008B5, 0x0008B6, 0x0008B7, 0x0008B8, 0x0008B9,
    0x0008BA, 0x00016E, 0x0003ED, 0x00078A, 0x0008BE, 0x0008BF, 0x00000C,
    0x0003EE, 0x00147F, 0x0008C3, 0x0008C4, 0x00078C, 0x000E32, 0x00078D,
    0x0008C8, 0x0008C9, 0x0008CA, 0x000091, 0x000092, 0x0008CD, 0x0008CE,
    0x0008CF, 0x0008D0, 0x00050B, 0x0016A1, 0x0008D3, 0x0008D4, 0x0008D5,
    0x0001DD, 0x0016A2, 0x000093, 0x0008D9, 0x0008DA, 0x0016A3, 0x0008DC,
    0x0008DD, 0x0008DE, 0x0008DF, 0x0008E0, 0x0008E1, 0x0008E2, 0x0008E3,
    0x0008E4, 0x000094, 0x0008E6, 0x0008E7, 0x0008E8, 0x00078F, 0x0008EA,
    0x0008EB, 0x0008EC, 0x0008ED, 0x0008EE, 0x0008EF, 0x0008F0, 0x0008F1,
    0x0000E9, 0x0016A4, 0x0008F4, 0x0008F5, 0x0008F6, 0x00050C, 0x000E8C,
    0x0008F9, 0x0008FA, 0x0008FB, 0x0007D0, 0x000097, 0x0008FE, 0x0008FF,
    0x000098, 0x000A01, 0x000A02, 0x000A03, 0x000A04, 0x000A05, 0x00016B,
    0x00009A, 0x00009A, 0x00009B, 0x000A0A, 0x00003B, 0x000E8D, 0x0007D1,
    0x000A0E, 0x000A0F, 0x000A10, 0x00009D, 0x000A12, 0x000A13, 0x000A14,
    0x000A15, 0x000A16, 0x000A17, 0x000A18, 0x000A19, 0x00028E, 0x0016A6,
    0x00009E, 0x000A1D, 0x000958, 0x0007D3, 0x000A20, 0x000A21, 0x000A22,
    0x000A23, 0x000A24, 0x000A25, 0x000A26, 0x000A27, 0x000A28, 0x000A29,
    0x000A2A, 0x000A2B, 0x000A2C, 0x000A2D, 0x000A2E, 0x000A2F, 0x0018C0,
    0x0018C1, 0x0018C2, 0x0018C3, 0x0018C4, 0x0018C5, 0x0018C6, 0x0018C7,
    0x009590, 0x009591,
};

static const uint16_t category3_symbol[] = {
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18,
    19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,
    36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52,
    53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69,
    70, 71, 72, 73, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87,
    88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 100, 101, 102, 103, 104,
    105, 106, 107, 108, 109, 110, 111, 112, 113, 115, 116, 117, 118,
    120, 121, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135,
    136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148,
    149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161,
    162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174,
    175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187,
    188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 200, 201,
    202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214,
    215, 216, 217, 218, 219, 220, 221, 222, 223, 225, 226, 227, 228,
    229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 240, 241, 242,
    243, 245, 246, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259,
    260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272,
    273, 275, 276, 277, 278, 279, 280, 281, 282, 283, 284, 285, 286,
    287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 300,
    301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 312, 313,
    314, 315, 316, 317, 318, 319, 320, 321, 322, 323, 325, 326, 327,
    328, 329, 330, 331, 332, 333, 334, 335, 336, 337, 338, 339, 340,
    341, 342, 343, 345, 346, 347, 350, 351, 352, 353, 355, 356, 357,
    358, 360, 361, 362, 363, 365, 366, 367, 375, 376, 377, 378, 379,
    380, 381, 382, 383, 384, 385, 386, 387, 388, 389, 390, 391, 392,
    393, 394, 395, 396, 397, 398, 400, 401, 402, 403, 404, 405, 406,
    407, 408, 409, 410, 411, 412, 413, 414, 415, 416, 417, 418, 419,
    420, 421, 422, 423, 425, 426, 427, 428, 429, 430, 431, 432, 433,
    434, 435, 436, 437, 438, 439, 440, 441, 442, 443, 445, 446, 447,
    450, 451, 452, 453, 454, 455, 456, 457, 458, 459, 460, 461, 462,
    463, 465, 466, 467, 468, 470, 471, 475, 476, 477, 478, 480, 481,
    482, 483, 485, 486, 487, 490, 491, 500, 501, 502, 503, 504, 505,
    506, 507, 508, 509, 510, 511, 512, 513, 515, 516, 517, 518, 520,
    521, 525, 526, 527, 528, 529, 530, 531, 532, 533, 534, 535, 536,
    537, 538, 540, 541, 542, 543, 545, 546, 550, 551, 552, 553, 555,
    556, 557, 558, 560, 561, 562, 563, 565, 566, 567, 575, 576, 577,
    578, 580, 581, 582, 583, 585, 586, 587, 590, 591, 600, 601, 605, 606,
};

static const uint8_t category3_len[] = {
    2, 4, 6, 8, 10, 5, 5, 6, 8, 10, 7, 8, 8, 10, 12, 9, 9, 10, 12, 15,
    10, 11, 13, 16, 16, 5, 6, 8, 10, 11, 5, 6, 8, 10, 12, 7, 7, 8, 10,
    13, 9, 9, 10, 12, 15, 12, 11, 13, 16, 16, 7, 9, 10, 12, 15, 7, 8,
    10, 12, 13, 9, 9, 11, 13, 16, 11, 11, 12, 14, 16, 12, 12, 14, 16,
    9, 11, 12, 16, 16, 9, 10, 13, 15, 16, 10, 11, 12, 16, 16, 13, 13,
    16, 16, 16, 16, 16, 15, 16, 11, 13, 16, 16, 15, 11, 13, 15, 16, 16,
    13, 13, 16, 16, 14, 16, 16, 16, 16, 16, 4, 6, 8, 10, 13, 6, 6, 8,
    10, 13, 9, 8, 10, 12, 16, 10, 10, 11, 15, 16, 13, 12, 14, 16, 16,
    5, 6, 8, 11, 13, 6, 6, 8, 10, 13, 8, 8, 9, 11, 14, 10, 10, 12, 12,
    16, 13, 12, 13, 15, 16, 7, 8, 9, 12, 16, 7, 8, 10, 12, 14, 9, 9,
    10, 13, 16, 11, 10, 12, 15, 16, 13, 13, 16, 16, 9, 11, 13, 16, 16,
    9, 10, 12, 15, 16, 10, 11, 13, 16, 16, 13, 12, 16, 16, 16, 16, 16,
    16, 16, 11, 13, 16, 16, 16, 11, 13, 16, 16, 16, 12, 13, 15, 16,
    16, 16, 16, 16, 16, 16, 6, 8, 11, 13, 16, 8, 8, 10, 12, 16, 11,
    10, 11, 13, 16, 12, 13, 13, 15, 16, 16, 16, 14, 16, 6, 8, 10, 13,
    16, 8, 8, 10, 12, 16, 10, 10, 11, 13, 16, 13, 12, 13, 16, 16, 14,
    14, 14, 16, 8, 9, 11, 13, 16, 8, 9, 11, 16, 14, 10, 10, 12, 15, 16,
    12, 12, 13, 16, 16, 15, 16, 16, 16, 10, 12, 15, 16, 16, 10, 12, 12,
    14, 16, 12, 12, 13, 16, 16, 14, 15, 16, 16, 16, 16, 16, 12, 15, 15,
    16, 13, 13, 16, 16, 14, 16, 16, 16, 16, 16, 16, 8, 10, 13, 15, 16,
    10, 11, 13, 16, 16, 13, 13, 14, 16, 16, 16, 16, 16, 16, 16, 16, 16,
    16, 16, 8, 10, 11, 15, 16, 9, 10, 12, 16, 16, 12, 12, 15, 16, 16,
    16, 14, 16, 16, 16, 16, 16, 16, 16, 9, 11, 14, 16, 16, 10, 11, 13,
    16, 16, 14, 13, 14, 16, 16, 16, 15, 15, 16, 16, 16, 16, 11, 13, 16,
    16, 16, 11, 13, 15, 16, 16, 13, 16, 16, 16, 16, 16, 16, 16, 16, 16,
    15, 16, 16, 16, 14, 16, 16, 16, 16, 16, 16, 16, 16, 9, 13, 16, 16,
    16, 11, 13, 16, 16, 16, 14, 15, 16, 16, 15, 16, 16, 16, 16, 16, 9,
    13, 15, 15, 16, 12, 13, 14, 16, 16, 16, 15, 16, 16, 16, 16, 16, 16,
    16, 16, 11, 13, 15, 16, 12, 14, 16, 16, 16, 16, 16, 16, 16, 16, 16,
    16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
};

static const uint16_t category4_code[] = {
    0x000001, 0x000002, 0x000004, 0x00023C, 0x00000A, 0x000000, 0x000045,
    0x0002C8, 0x00005B, 0x00000A, 0x00002E, 0x0023DE, 0x000592, 0x000596,
    0x0075DC, 0x0075F2, 0x000009, 0x00001C, 0x000016, 0x0008D2, 0x000010,
    0x000019, 0x00008E, 0x000883, 0x00000F, 0x00006F, 0x0002CF, 0x0005F1,
    0x00046B, 0x00059D, 0x0005F0, 0x0075F4, 0x000058, 0x00011B, 0x000EDB,
    0x0075F1, 0x00000D, 0x0000EC, 0x000B28, 0x0075D6, 0x000221, 0x0003B7,
    0x00164D, 0x0005F2, 0x000CA9, 0x0023DC, 0x0075E3, 0x000440, 0x001104,
    0x0076CA, 0x0075DF, 0x00047A, 0x000179, 0x0075D2, 0x0075D3, 0x00220B,
    0x0075E0, 0x0075D5, 0x0075F5, 0x0075E8, 0x000001, 0x000017, 0x00001C,
    0x00164E, 0x00001A, 0x00000E, 0x00001D, 0x001D72, 0x000066, 0x000067,
    0x000595, 0x0005F4, 0x000CA5, 0x001B94, 0x0076C1, 0x0075F9, 0x00000F,
    0x00000D, 0x0001D6, 0x000EB8, 0x000018, 0x00000F, 0x000119, 0x001673,
    0x000018, 0x0000B5, 0x000468, 0x0075FE, 0x00164F, 0x000DCB, 0x0075CC,
    0x0075CE, 0x000074, 0x000064, 0x0008D4, 0x0075EB, 0x000077, 0x0000EA,
    0x0006E4, 0x0075DB, 0x0002CC, 0x000373, 0x0023DF, 0x0075D4, 0x000CA4,
    0x0005F8, 0x0075E4, 0x000375, 0x000B36, 0x0005FC, 0x0075D0, 0x000597,
    0x00164C, 0x0075F0, 0x0075FD, 0x0076C2, 0x0075D8, 0x0075DD, 0x0075CD,
    0x0075D1, 0x000036, 0x000019, 0x000655, 0x003B6B, 0x0000B4, 0x00011F,
    0x0008D5, 0x0075F6, 0x000328, 0x00032B, 0x0076CB, 0x0076CD, 0x0076CE,
    0x0059CA, 0x0059CB, 0x000018, 0x000111, 0x000178, 0x0075CF, 0x000089,
    0x000118, 0x000B37, 0x0005F3, 0x0006E8, 0x0008D3, 0x0005F5, 0x0075D7,
    0x0005F6, 0x0075D9, 0x0075DA, 0x0001BB, 0x00059A, 0x0005F7, 0x0075DE,
    0x0001DA, 0x0006E9, 0x0075E1, 0x0075E2, 0x000CA6, 0x000CA7, 0x0075E5,
    0x0075E6, 0x0075E7, 0x000CA8, 0x0075E9, 0x0075EA, 0x0023DD, 0x0075EC,
    0x0075ED, 0x0075EE, 0x0075EF, 0x0001B8, 0x000B29, 0x0005F9, 0x0075F3,
    0x0008F6, 0x001B95, 0x0005FA, 0x0075F7, 0x0075F8, 0x0005FB, 0x0075FA,
    0x0075FB, 0x0075FC, 0x0000CB, 0x000B38, 0x0075FF, 0x0076C0, 0x0000BD,
    0x002CE4, 0x0076C3, 0x0076C4, 0x0076C5, 0x0076C6, 0x0076C7, 0x0076C8,
    0x0076C9, 0x00220A, 0x0005FD, 0x0076CC, 0x0005FE, 0x0005FF, 0x0076CF,
    0x0076D0, 0x0076D1, 0x0076D2, 0x0076D3, 0x0076D4, 0x0076D5,
};

static const uint16_t category4_symbol[] = {
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18,
    19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34,
    35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 48, 49, 50, 51,
    52, 53, 54, 55, 56, 57, 58, 60, 61, 64, 65, 66, 67, 68, 69, 70,
    71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86,
    87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102,
    103, 104, 105, 106, 107, 108, 109, 110, 112, 113, 114, 115, 116,
    117, 118, 119, 120, 121, 122, 124, 125, 128, 129, 130, 131, 132,
    133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 144, 145, 146,
    147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 160,
    161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 172, 173, 176,
    177, 178, 180, 181, 182, 184, 185, 192, 193, 194, 195, 196, 197,
    198, 199, 200, 201, 202, 204, 205, 208, 209, 210, 211, 212, 213,
    214, 215, 216, 217, 218, 220, 221, 224, 225, 226, 228, 229, 230,
    232, 233, 240, 241, 244, 245,
};

static const uint8_t category4_len[] = {
    2, 4, 7, 10, 4, 5, 7, 10, 7, 8, 10, 14, 11, 11, 15, 15, 4, 5, 9,
    12, 5, 5, 8, 12, 8, 7, 10, 15, 11, 11, 15, 15, 7, 9, 12, 15, 8, 8,
    12, 15, 10, 10, 13, 15, 14, 14, 15, 11, 13, 15, 15, 11, 13, 15,
    15, 14, 15, 15, 15, 15, 4, 5, 9, 13, 5, 6, 9, 13, 9, 9, 11, 15,
    14, 13, 15, 15, 4, 6, 9, 12, 5, 6, 9, 13, 9, 8, 11, 15, 13, 12,
    15, 15, 7, 9, 12, 15, 7, 8, 11, 15, 10, 10, 14, 15, 14, 15, 15,
    10, 12, 15, 15, 11, 13, 15, 15, 15, 15, 15, 15, 15, 6, 9, 13, 14,
    8, 9, 12, 15, 12, 12, 15, 15, 15, 15, 15, 7, 9, 13, 15, 8, 9, 12,
    15, 11, 12, 15, 15, 15, 15, 15, 9, 11, 15, 15, 9, 11, 15, 15, 14,
    14, 15, 15, 15, 14, 15, 15, 14, 15, 15, 15, 15, 9, 12, 15, 15, 12,
    13, 15, 15, 15, 15, 15, 15, 15, 10, 12, 15, 15, 12, 14, 15, 15,
    15, 15, 15, 15, 15, 14, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15,
};

static const uint16_t category5_code[] = {
    0x000000, 0x000005, 0x0000DC, 0x00000A, 0x000010, 0x0001BB, 0x000186,
    0x000187, 0x0037FD, 0x00000B, 0x00001A, 0x00061E, 0x00001A, 0x000036,
    0x000C3F, 0x0001FC, 0x000616, 0x006FA5, 0x0000FF, 0x0006F6, 0x006FB7,
    0x000375, 0x001840, 0x006FA2, 0x0037FF, 0x006FA3, 0x000009, 0x000023,
    0x000C39, 0x00001B, 0x000044, 0x000DD1, 0x00061A, 0x000DF0, 0x006FC2,
    0x000019, 0x00003E, 0x000FEE, 0x00003A, 0x000076, 0x001E53, 0x000C23,
    0x001E4E, 0x006F93, 0x00030A, 0x000C3B, 0x006FB6, 0x00030C, 0x001BD3,
    0x006FD6, 0x006FB1, 0x006FAA, 0x0000F3, 0x001842, 0x006FC6, 0x0003FA,
    0x000DEF, 0x006FB9, 0x006FC3, 0x006F9A, 0x000184, 0x001870, 0x006FCB,
    0x000617, 0x006F92, 0x006FBE, 0x006F95, 0x006FAF, 0x006FB2, 0x006F9B,
    0x006FCA, 0x006FAE, 0x000004, 0x00001C, 0x0006F5, 0x00001F, 0x00003C,
    0x000C3E, 0x000792, 0x000F2A, 0x006F9E, 0x000019, 0x000060, 0x001E4D,
    0x000031, 0x00007E, 0x0037A4, 0x000F2B, 0x0037FE, 0x006FC5, 0x0006E9,
    0x000FED, 0x006FBA, 0x000C22, 0x001E4C, 0x006FA6, 0x006FCD, 0x006F96,
    0x00000E, 0x00003D, 0x000FEF, 0x00003D, 0x00008A, 0x006F4B, 0x000DD0,
    0x001FD9, 0x006F9D, 0x000031, 0x000060, 0x00309A, 0x000077, 0x0000F0,
    0x006F4A, 0x00309B, 0x006F90, 0x006F91, 0x000C27, 0x000DFC, 0x006F94,
    0x000C3A, 0x001E4F, 0x006F97, 0x006F98, 0x006F99, 0x0001BC, 0x001841,
    0x006F9C, 0x000DF1, 0x001843, 0x006F9F, 0x006FA0, 0x006FA1, 0x00030A,
    0x001E50, 0x006FA4, 0x001E51, 0x001E52, 0x006FA7, 0x006FA8, 0x006FA9,
    0x0037EF, 0x006FAB, 0x006FAC, 0x006FAD, 0x00008B, 0x0003C8, 0x006FB0,
    0x000612, 0x000DFD, 0x006FB3, 0x006FB4, 0x006FB5, 0x0003CB, 0x000DE8,
    0x006FB8, 0x000DFE, 0x001BDC, 0x006FBB, 0x006FBC, 0x006FBD, 0x0037FC,
    0x006FBF, 0x006FC0, 0x006FC1, 0x0000F1, 0x000616, 0x006FC4, 0x00061B,
    0x001871, 0x006FC7, 0x006FC8, 0x006FC9, 0x000617, 0x001BDD, 0x006FCC,
    0x00184C, 0x006FCE, 0x006FCF, 0x006FD0, 0x006FD1, 0x006FD2, 0x006FD3,
    0x006FD4, 0x006FD5, 0x001FD8, 0x006FD7, 0x006FD8, 0x006FD9, 0x006FDA,
    0x006FDB, 0x006FDC, 0x006FDD,
};

static const uint16_t category5_symbol[] = {
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18,
    19, 20, 21, 22, 23, 24, 25, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36,
    37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 54,
    55, 56, 57, 58, 59, 60, 61, 63, 64, 65, 66, 67, 68, 69, 70, 72, 73,
    75, 76, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94,
    95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 108, 109,
    110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122,
    123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 135, 136,
    137, 138, 139, 140, 141, 142, 144, 145, 146, 147, 148, 149, 150,
    151, 153, 154, 156, 157, 162, 163, 164, 165, 166, 167, 168, 169,
    171, 172, 173, 174, 175, 176, 177, 178, 180, 181, 183, 184, 189,
    190, 191, 192, 193, 194, 195, 196, 198, 199, 200, 201, 202, 203,
    204, 205, 207, 208, 210, 211, 216, 217, 219, 220, 225, 226, 228, 229,
};

static const uint8_t category5_len[] = {
    2, 4, 8, 4, 5, 9, 9, 10, 14, 4, 6, 11, 5, 6, 12, 10, 11, 15, 9,
    11, 15, 10, 13, 15, 14, 15, 4, 6, 12, 6, 7, 12, 12, 12, 15, 5, 7,
    13, 6, 7, 13, 12, 13, 15, 10, 12, 15, 11, 13, 15, 15, 15, 8, 13,
    15, 11, 12, 15, 15, 15, 10, 13, 15, 12, 15, 15, 15, 15, 15, 15, 15,
    15, 4, 5, 11, 5, 7, 12, 11, 12, 15, 6, 7, 13, 7, 8, 14, 12, 14, 15,
    11, 13, 15, 12, 13, 15, 15, 15, 5, 6, 13, 7, 8, 15, 12, 14, 15, 6,
    8, 14, 7, 8, 15, 14, 15, 15, 12, 12, 15, 12, 13, 15, 15, 15, 9, 13,
    15, 12, 13, 15, 15, 15, 11, 13, 15, 13, 13, 15, 15, 15, 14, 15, 15,
    15, 8, 10, 15, 11, 12, 15, 15, 15, 10, 12, 15, 12, 13, 15, 15, 15,
    14, 15, 15, 15, 8, 12, 15, 12, 13, 15, 15, 15, 11, 13, 15, 13, 15,
    15, 15, 15, 15, 15, 15, 15, 14, 15, 15, 15, 15, 15, 15, 15,
};

static const uint16_t category6_code[] = {
    0x000001, 0x000002, 0x000004, 0x000002, 0x000005, 0x00001D, 0x000018,
    0x000065, 0x000003, 0x00001F, 0x00001C, 0x000069, 0x000003, 0x000005,
    0x000066, 0x0001A8, 0x000001, 0x00001E, 0x000000, 0x00006B, 0x00001B,
    0x0000C8, 0x000067, 0x000326, 0x000001, 0x000004, 0x000068, 0x000192,
    0x000003, 0x0001A9, 0x0000D5, 0x000327,
};

static const uint16_t category6_symbol[] = {
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18,
    19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31,
};

static const uint8_t category6_len[] = {
    1, 4, 4, 6, 4, 6, 6, 8, 4, 6, 6, 8, 6, 9, 8, 10, 4, 6, 7, 8, 6, 9,
    8, 11, 6, 9, 8, 10, 8, 10, 9, 11,
};

static const uint8_t *const category_len_tab[7] = {
    category0_len,
    category1_len,
    category2_len,
    category3_len,
    category4_len,
    category5_len,
    category6_len,
};

static const uint16_t *const category_symbol_tab[7] = {
    category0_symbol,
    category1_symbol,
    category2_symbol,
    category3_symbol,
    category4_symbol,
    category5_symbol,
    category6_symbol,
};

static const uint16_t *const category_code_tab[7] = {
    category0_code,
    category1_code,
    category2_code,
    category3_code,
    category4_code,
    category5_code,
    category6_code,
};

static const uint16_t category_size_tab[7] = {
    FF_ARRAY_ELEMS(category0_len),
    FF_ARRAY_ELEMS(category1_len),
    FF_ARRAY_ELEMS(category2_len),
    FF_ARRAY_ELEMS(category3_len),
    FF_ARRAY_ELEMS(category4_len),
    FF_ARRAY_ELEMS(category5_len),
    FF_ARRAY_ELEMS(category6_len)
};

static const float mlt_quant[8][16] = {
    {    0, 1606, 3119, 4586, 6049, 7502, 8941,10406,11851,13292,14736,16146,17566,19351,    0,    0},
    {    0, 2229, 4341, 6401, 8471,10531,12583,14588,16673,18924,    0,    0,    0,    0,    0,    0},
    {    0, 3055, 5998, 8929,11806,14680,17680,    0,    0,    0,    0,    0,    0,    0,    0,    0},
    {    0, 4121, 8192,12259,16322,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0},
    {    0, 5413,11071,16315,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0},
    {    0, 6785,14300,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0},
    {    0, 8044,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0},
    {    0, 8019,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0}
};

static const int16_t standard_deviation[] = {
        0,   0,   0,    0,    0,    0,    0,    0,
        0,   0,   0,    0,    0,    0,    0,    0,
        0,   0,   0,    0,    0,    0,    1,    1,
        1,   1,   2,    3,    4,    6,    8,   11,
       16,  23,  32,   45,   64,   91,  128,  181,
      256, 362, 512,  724, 1024, 1448, 2048, 2896,
     4096,5793,8192,11585,16384,23170,    0,    0,
        0,   0,   0,    0,    0,    0,    0,    0,
};

static const int8_t max_bin_plus1[] = {
    14, 10, 7, 5, 4, 3, 2, 0,
};

static const uint16_t max_bin_plus_one_inverse_scaled[] = {
    4682, 6554, 9363, 13108, 16384, 21846, 32768, 0,
};

#define FRAME_SIZE 640
#define REGION_SIZE 20

typedef struct ChanContext {
    uint32_t random_value;
    int mod_shift;

    int power_categories[28];
    int category_balance[31];
    int absolute_region_power_index[28];
    float decoder_standard_deviation[28];

    DECLARE_ALIGNED(32, float, imdct_buf)[3][FRAME_SIZE];
    float          *imdct_in;
    float          *imdct_out;
    float          *imdct_prev;
} ChanContext;

static VLC vlc_diff[13];
static VLC vlc_category[7];

typedef struct G7221Context {
    GetBitContext gb;

    DECLARE_ALIGNED(32, float, window)[FRAME_SIZE];

    ChanContext chc[2];

    uint8_t *bitstream;
    int bitstream_size;

    BswapDSPContext    bdsp;
    AVFloatDSPContext *fdsp;
    av_tx_fn           tx_fn;
    AVTXContext       *tx_ctx;
} G7221Context;

static void g722_1_init_static_data(void)
{
    for (int i = 0; i < 13; i++) {
        vlc_init(&vlc_diff[i], 9, sizeof(diff_len[i]),
                 diff_len[i], 1, 1, diff_code[i], 2, 2, 0);
    }

    for (int i = 0; i < 7; i++) {
        ff_vlc_init_sparse(&vlc_category[i], 9, category_size_tab[i],
                           category_len_tab[i], 1, 1, category_code_tab[i], 2, 2,
                           category_symbol_tab[i], 2, 2, 0);
    }
}

static av_cold int g722_1_init(AVCodecContext *avctx)
{
    static AVOnce init_static_once = AV_ONCE_INIT;
    G7221Context *s = avctx->priv_data;
    float scale;

    if (avctx->ch_layout.nb_channels < 1 ||
        avctx->ch_layout.nb_channels > 2)
        return AVERROR_INVALIDDATA;

    ff_thread_once(&init_static_once, g722_1_init_static_data);

    for (int ch = 0; ch < 2; ch++) {
        ChanContext *c = &s->chc[ch];

        c->imdct_in   = c->imdct_buf[0];
        c->imdct_out  = c->imdct_buf[1];
        c->imdct_prev = c->imdct_buf[2];
        c->random_value = 0x10001;
    }

    avctx->sample_fmt = AV_SAMPLE_FMT_FLTP;

    scale = 1.f / 32768.f;

    for (int i = 0; i < FRAME_SIZE; i++) {
        const float angle = ((i + 0.5f) * M_PI_2) / FRAME_SIZE;

        s->window[i] = sinf(angle);
    }

    ff_bswapdsp_init(&s->bdsp);

    s->fdsp = avpriv_float_dsp_alloc(avctx->flags & AV_CODEC_FLAG_BITEXACT);
    if (!s->fdsp)
        return AVERROR(ENOMEM);

    return av_tx_init(&s->tx_ctx, &s->tx_fn, AV_TX_FLOAT_MDCT, 1, FRAME_SIZE, &scale, 0);
}

static int decode_envelope(G7221Context *s, GetBitContext *gb,
                           int number_of_regions, int *absolute_region_power_index)
{
    absolute_region_power_index[0] = (int)get_bits(gb, 5) - 7;
    absolute_region_power_index[0] = av_clip(absolute_region_power_index[0], -24, 39);

    for (int i = 1; i < number_of_regions; i++) {
        int index, region_index = i > 13 ? 13 - 1 : i - 1;

        index = get_vlc2(gb, vlc_diff[region_index].table, 9, 2);
        if (index < 0)
            return AVERROR_INVALIDDATA;

        absolute_region_power_index[i] = absolute_region_power_index[i - 1] + index - 12;
    }

    return get_bits_left(gb);
}

static int categorize_regions(const int number_of_regions, int number_of_available_bits,
                              int *absolute_region_power_index, int *power_categories,
                              int *category_balance, const int rate_control_possibilities)
{
    int delta, i, temp;
    int expected_number_of_code_bits;
    int min_rate_ptr, max_rate_ptr;
    int min, max, offset, raw_value;
    int temp_category_balances[64];
    int max_rate_categories[28];
    int min_rate_categories[28];

    if (number_of_available_bits > FRAME_SIZE)
        number_of_available_bits = 5 * (number_of_available_bits - FRAME_SIZE) / 8 + FRAME_SIZE;

    offset = -32;
    for (delta = 32; delta > 0; delta /= 2) {
        int test_offset = offset + delta;

        expected_number_of_code_bits = 0;
        for (int region = 0; region < number_of_regions; region++) {
            i = (test_offset - absolute_region_power_index[region]) / 2;
            i = av_clip_uintp2(i, 3);
            power_categories[region] = i;
            expected_number_of_code_bits += expected_bits_table[i];
        }

        if (expected_number_of_code_bits >= number_of_available_bits - 32)
            offset = test_offset;
    }

    expected_number_of_code_bits = 0;
    for (int region = 0; region < number_of_regions; region++) {
        i = (offset - absolute_region_power_index[region]) >> 1;
        i = av_clip_uintp2(i, 3);
        max_rate_categories[region] = min_rate_categories[region] =
            power_categories[region] = i;
        expected_number_of_code_bits += expected_bits_table[i];
    }

    min = max = expected_number_of_code_bits;
    min_rate_ptr = max_rate_ptr = rate_control_possibilities;
    for (i = 0; i < rate_control_possibilities - 1; i++) {
        if (min + max > number_of_available_bits * 2) {
            int raw_max_idx = 27;

            raw_value = -10000;
            for (int region = number_of_regions - 1; region >= 0; region--) {
                if (min_rate_categories[region] < 7) {
                    temp = offset - absolute_region_power_index[region] -
                        2 * min_rate_categories[region];
                    if (temp > raw_value) {
                        raw_value = temp;
                        raw_max_idx = region;
                    }
                }
            }
            if (raw_value == -10000)
                return AVERROR_INVALIDDATA;

            temp_category_balances[min_rate_ptr] = raw_max_idx;
            min_rate_ptr++;

            min -= expected_bits_table[min_rate_categories[raw_max_idx]];
            min_rate_categories[raw_max_idx]++;
            min += expected_bits_table[min_rate_categories[raw_max_idx]];
        } else {
            int raw_min_idx = 0;

            raw_value = 10000;
            for (int region = 0; region < number_of_regions; region++) {
                if (max_rate_categories[region] > 0) {
                    temp = offset - absolute_region_power_index[region] -
                        2 * max_rate_categories[region];
                    if (temp < raw_value) {
                        raw_value = temp;
                        raw_min_idx = region;
                    }
                }
            }
            if (raw_value == 10000)
                return AVERROR_INVALIDDATA;

            max_rate_ptr--;
            temp_category_balances[max_rate_ptr] = raw_min_idx;

            max -= expected_bits_table[max_rate_categories[raw_min_idx]];
            max_rate_categories[raw_min_idx]--;
            max += expected_bits_table[max_rate_categories[raw_min_idx]];
        }
    }

    for (int region = 0; region < number_of_regions; region++)
        power_categories[region] = max_rate_categories[region];

    for (i = 0; i < 32 - 1; i++)
        category_balance[i] = temp_category_balances[max_rate_ptr + i];

    return 0;
}

static inline void index_to_array(int index, int *array_cv, int category)
{
    int max_bin_plus_one = max_bin_plus1[category];
    int inverse_of_max_bin_plus_one_scaled = max_bin_plus_one_inverse_scaled[category];
    int q, p;

    p = index;
    switch (category) {
    case 0:
    case 1:
    case 2:
        q = (p * inverse_of_max_bin_plus_one_scaled) >> 16;
        array_cv[1] = p - (q * max_bin_plus_one);
        p = q;

        q = (q * inverse_of_max_bin_plus_one_scaled) >> 16;
        array_cv[0] = p - (q * max_bin_plus_one);
        break;
    case 3:
        q = (p * inverse_of_max_bin_plus_one_scaled) >> 16;
        array_cv[3] = p - (q * 5);
        p = q;

        q = (q * inverse_of_max_bin_plus_one_scaled) >> 16;
        array_cv[2] = p - (q * 5);
        p = q;

        q = (q * inverse_of_max_bin_plus_one_scaled) >> 16;
        array_cv[1] = p - (q * 5);
        p = q;

        q = (q * inverse_of_max_bin_plus_one_scaled) >> 16;
        array_cv[0] = p - (q * 5);
        break;
    case 4:
        array_cv[3] = p & 3;
        p >>= 2;

        array_cv[2] = p & 3;
        p >>= 2;

        array_cv[1] = p & 3;
        p >>= 2;

        array_cv[0] = p & 3;
        break;
    case 5:
        q = (p * inverse_of_max_bin_plus_one_scaled) >> 16;
        array_cv[4] = p - (q * 3);
        p = q;

        q = (q * inverse_of_max_bin_plus_one_scaled) >> 16;
        array_cv[3] = p - (q * 3);
        p = q;

        q = (q * inverse_of_max_bin_plus_one_scaled) >> 16;
        array_cv[2] = p - (q * 3);
        p = q;

        q = (q * inverse_of_max_bin_plus_one_scaled) >> 16;
        array_cv[1] = p - (q * 3);
        p = q;

        q = (q * inverse_of_max_bin_plus_one_scaled) >> 16;
        array_cv[0] = p - (q * 3);
        break;
    case 6:
        array_cv[4] = p & 1;
        p >>= 1;

        array_cv[3] = p & 1;
        p >>= 1;

        array_cv[2] = p & 1;
        p >>= 1;

        array_cv[1] = p & 1;
        p >>= 1;

        array_cv[0] = p & 1;
        break;
    default:
        break;
    }
}

static int decode_vector_quantized_indices(G7221Context *s, ChanContext *c,
                                           const float *decoder_region_standard_deviation,
                                           int *power_categories, float *coefs,
                                           uint32_t *p_random_value)
{
    GetBitContext *gb = &s->gb;
    int array_cv[5] = {0};

    for (int region = 0; region < 28; region++)  {
        float standard_deviation = decoder_region_standard_deviation[region];
        int category = power_categories[region];

        if (category < 7) {
            float *decoder_mlt_ptr = &coefs[region * REGION_SIZE];

            for (int v = 0; v < number_of_vectors[category]; v++)  {
                int index;

                if (get_bits_left(gb) <= 0) {
                    category = 7;
                    break;
                }

                index = get_vlc2(gb, vlc_category[category].table, 9, 2);
                if (index < 0) {
                    category = 7;
                    break;
                }

                index_to_array(index, array_cv, category);

                for (int i = 0; i < vector_dimension[category]; i++) {
                    float decoder_mlt_value = 0.f, negative;

                    if (array_cv[i] != 0) {
                        decoder_mlt_value = standard_deviation * mlt_quant[category][array_cv[i]] / 8192.f;

                        negative = get_bits1(gb);
                        if (negative == 0)
                            decoder_mlt_value = -decoder_mlt_value;
                    }

                    *decoder_mlt_ptr = decoder_mlt_value;
                    decoder_mlt_ptr++;
                }
            }
        }

        if (category >= 5) {
            static const float noise_fill_factor[3] = { 0.176777f, 0.25f, 0.707107f };
            float *decoder_mlt_ptr = &coefs[region * REGION_SIZE];
            float noise_fill_pos = standard_deviation * noise_fill_factor[category - 5];
            float noise_fill_neg = -noise_fill_pos;
            uint32_t random_value;

            *p_random_value *= 69069;
            random_value = *p_random_value;

            if (category >= 7) {
                for (int i = 0; i < REGION_SIZE; i++) {
                    if (random_value & 1)
                        *decoder_mlt_ptr = noise_fill_pos;
                    else
                        *decoder_mlt_ptr = noise_fill_neg;
                    random_value >>= 1;
                    decoder_mlt_ptr++;
                }
            } else {
                for (int i = 0; i < REGION_SIZE; i++)  {
                    if (*decoder_mlt_ptr == 0.f) {
                        if (random_value & 1)
                            *decoder_mlt_ptr = noise_fill_pos;
                        else
                            *decoder_mlt_ptr = noise_fill_neg;
                        random_value >>= 1;
                    }
                    decoder_mlt_ptr++;
                }
            }
        }
    }

    return 0;
}

static int decode_vector(G7221Context *s, ChanContext *c, int number_of_regions,
                         const int *absolute_region_power_index,
                         float *decoder_standard_deviation,
                         int *power_categories, float *coefs, int *mod_shift)
{
    int region_index, max_index = 0;

    for (int region = 0; region < number_of_regions; region++) {
        region_index = absolute_region_power_index[region];
        max_index = FFMAX(max_index, region_index);
    }

    max_index += 24;
    region_index = 9;
    while ((region_index >= 0) && (max_index > 28)) {
        max_index -= 2;
        region_index--;
    }

    for (int region = 0; region < number_of_regions; region++) {
        int rsd_index = absolute_region_power_index[region] + 24 + region_index * 2;
        decoder_standard_deviation[region] = standard_deviation[rsd_index];
    }

    *mod_shift = region_index - 1;
    return decode_vector_quantized_indices(s, c, decoder_standard_deviation,
                                           power_categories, coefs, &c->random_value);
}

static int g722_1_decode(AVCodecContext *avctx, AVFrame *frame,
                         int *got_frame, AVPacket *avpkt)
{
    const int nb_channels = avctx->ch_layout.nb_channels;
    G7221Context *s = avctx->priv_data;
    GetBitContext *gb = &s->gb;
    int ret, rate_control, bits_per_frame;

    av_fast_padded_malloc(&s->bitstream, &s->bitstream_size, avpkt->size);

    s->bdsp.bswap16_buf((uint16_t *)s->bitstream,
                        (uint16_t *)avpkt->data,
                        (avpkt->size + 1) >> 1);

    bits_per_frame = nb_channels * (avctx->sample_rate / 50);

    if (avpkt->size < (bits_per_frame / 8))
        return AVERROR_INVALIDDATA;

    for (int ch = 0; ch < nb_channels; ch++) {
        ChanContext *c = &s->chc[ch];
        const int bits_per_ch = bits_per_frame / nb_channels;
        const uint8_t *bitstream = s->bitstream;

        if ((ret = init_get_bits8(gb, bitstream + ch*(bits_per_ch/8), bits_per_ch/8)) < 0)
            return ret;

        memset(c->imdct_in, 0, FRAME_SIZE * sizeof(*c->imdct_in));
        memset(c->power_categories, 0, sizeof(c->power_categories));
        memset(c->category_balance, 0, sizeof(c->category_balance));
        memset(c->absolute_region_power_index, 0, sizeof(c->absolute_region_power_index));
        memset(c->decoder_standard_deviation, 0, sizeof(c->decoder_standard_deviation));

        ret = decode_envelope(s, gb, 28, c->absolute_region_power_index);
        if (ret < 0)
            return ret;

        rate_control = get_bits(gb, 5);

        ret = categorize_regions(28, get_bits_left(gb),
                                 c->absolute_region_power_index, c->power_categories,
                                 c->category_balance, 32);
        if (ret < 0)
            return ret;

        for (int i = 0; i < rate_control; i++)
            c->power_categories[c->category_balance[i]]++;

        ret = decode_vector(s, c, 28, c->absolute_region_power_index,
                            c->decoder_standard_deviation, c->power_categories,
                            c->imdct_in, &c->mod_shift);
        if (ret < 0)
            return ret;
    }

    frame->nb_samples = FRAME_SIZE;
    if ((ret = ff_get_buffer(avctx, frame, 0)) < 0)
        return ret;

    for (int ch = 0; ch < nb_channels; ch++) {
        ChanContext *c = &s->chc[ch];
        int mod_shift = c->mod_shift;
        float scale;

        if (mod_shift <= 0)
            scale = 1 << (-mod_shift);
        else
            scale = 1.f / (1 << (mod_shift));

        for (int i = 0; i < FRAME_SIZE; i += 2)
            c->imdct_in[i] *= -1.f;

        s->tx_fn(s->tx_ctx, c->imdct_out, c->imdct_in, sizeof(float));

        for (int i = 0; i < FRAME_SIZE; i++)
            c->imdct_out[i] *= scale;

        s->fdsp->vector_fmul_window((float *)frame->extended_data[ch],
                                    c->imdct_prev, c->imdct_out,
                                    s->window, FRAME_SIZE >> 1);
        memcpy(c->imdct_prev, c->imdct_out + (FRAME_SIZE >> 1), (FRAME_SIZE >> 1) * sizeof(float));
    }

    *got_frame = 1;

    return bits_per_frame / 8;
}

static av_cold void g722_1_flush(AVCodecContext *avctx)
{
    G7221Context *s = avctx->priv_data;

    for (int ch = 0; ch < avctx->ch_layout.nb_channels; ch++) {
        ChanContext *c = &s->chc[ch];

        memset(c->imdct_prev, 0, FRAME_SIZE * sizeof(*c->imdct_prev));
        memset(c->imdct_out, 0, FRAME_SIZE * sizeof(*c->imdct_out));
    }
}

static av_cold int g722_1_close(AVCodecContext *avctx)
{
    G7221Context *s = avctx->priv_data;

    av_freep(&s->bitstream);
    av_freep(&s->fdsp);
    av_tx_uninit(&s->tx_ctx);

    return 0;
}

const FFCodec ff_g722_1_decoder = {
    .p.name         = "g722_1",
    CODEC_LONG_NAME("G.722.1 C"),
    .priv_data_size = sizeof(G7221Context),
    .p.type         = AVMEDIA_TYPE_AUDIO,
    .p.id           = AV_CODEC_ID_G722_1,
    .init           = g722_1_init,
    .close          = g722_1_close,
    FF_CODEC_DECODE_CB(g722_1_decode),
    .flush          = g722_1_flush,
    .p.capabilities = AV_CODEC_CAP_DR1,
    .caps_internal  = FF_CODEC_CAP_INIT_CLEANUP,
};
